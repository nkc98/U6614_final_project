---
title: "Did Medicaid Expansion Change the Trajectory of Drug Overdose Deaths in Appalachia?"
author: "Neil Chin (nkc2124) & Nicole Yahui Wu (yw3551)"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  pdf_document:
    keep_tex: false
    fig_caption: true
    latex_engine: pdflatex
    toc: no
    toc_depth: '3'
    number_sections: yes
header-includes:
  -  \usepackage{hyperref}
  - \usepackage{placeins}
biblio-style: apsr
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
# spacing: double
endnote: no
urlcolor: blue

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE,
                      message=FALSE, warning=FALSE, echo=FALSE,
                      fig.path='figs/',
                      cache.path = '_cache/',
                      fig.process = function(x) {
                      x2 = sub('-\\d+([.][a-z]+)$', '\\1', x)
                      if (file.rename(x, x2)) x2 else x
                      })
```

```{r}
library(tidyverse) 
library(tidycensus)
library(readxl)
library(lubridate)
library(kableExtra)
library(sf)
library(tmap)
library(panelr)
library(fixest)
library(modelsummary)
```

# Introduction

Deaths due to drug overdose are a pressing problem facing United States policymakers and society at large, with reportedly more than 932,000 people dying due to overdose since 1999 ([CDC, 2022](https://www.cdc.gov/drugoverdose/deaths/index.html)). Rates of overdose deaths increased in nearly every US state from 2013-2017, with particularly severe incidence in the Appalachian region ([CDC, 2020](https://www.cdc.gov/drugoverdose/deaths/2013-2017-increase.html); [CDC, 2021](https://www.cdc.gov/drugoverdose/deaths/2014.html)). The increase in deaths is driven primarily by the ongoing US opioid crisis, with the vast majority (>80%) of overdose deaths associated with opioid use ([CDC, 2022](https://www.cdc.gov/drugoverdose/deaths/index.html)).

In this context, we hope to assess whether expansion of the social safety net through government policy can be causally linked to reductions in drug overdose death rates. Specifically, we propose to estimate the effects of the expansion of the US Medicaid program using a panel dataset of Appalachian counties, which increased income-based eligibility for healthcare (including drug addiction treatment) in some Appalachian states, on drug overdose deaths. We hope that the findings from this study can assist policymakers in determining whether expanding access to healthcare in low-income areas is a viable policy mechanism for addressing the ongoing drug overdose crisis.



\medspace

# Policy Background

The Affordable Care Act (ACA) was passed by the United States Congress and signed into law by President Barack Obama in 2010, drastically changing the policy landscape for health care in the United States. Among the major provisions in the ACA was expanded eligibility for Medicaid (i.e., "Medicaid Expansion"), which allowed states to raise the income-eligibility threshold to 138% of the federal poverty level ([KFF, 2022](https://www.kff.org/medicaid/issue-brief/status-of-state-medicaid-expansion-decisions-interactive-map/)). 

Of the 13 states whose boundaries overlap with the broad geographical definition of Appalachia, five states (Kentucky, Maryland, New York, Ohio, and West Virginia) passed legislation mandating the expansion of Medicaid as of January 1st, 2014 ([KFF, 2022](https://www.kff.org/medicaid/issue-brief/status-of-state-medicaid-expansion-decisions-interactive-map/)). Two additional states, Pennsylvania and Virginia, would later expand Medicaid, with the former in 2015 and the latter in 2019. Six states (Alabama, Georgia, Mississippi, North Carolina, South Carolina, and Tennessee) have not expanded Medicaid to-date. 

In our study, we identify this policy adoption discrepancy as a "treatment" (i.e., "differential exposure between entities over time") affecting drug overdose incidence in Appalachian communities. Our *hypothesized* causal mechanism is that expanded Medicaid eligibility allowed for greater access to low-cost health care among Appalachian counties in expansion states, therefore enabling people struggling with drug addiction to receive treatment when they otherwise would not have been able to receive care, reducing overall deaths from drug overdose in these areas.

\medspace

# Data Description

```{r load date, include = FALSE}
# Load panel data
year_county_panel <- readRDS("yearly_panel.rds")

# Load county data
appalachian_counties <- readRDS("appalachian_counties.rds")
expansion_count <- as.numeric(table(appalachian_counties$medicaid_expansion))

# Turn panel into panel format, limit to 3 years prior and 5 years after
YC_panel <- panel_data(year_county_panel, id = "COUNTY", wave = "Year") %>% 
  filter(between(t_expansion, -3, 4))
```

Our data is a county-year panel dataset, which we use to examine drug overdose deaths in Appalachian counties over the period 2011-2019. In total, this panel dataset is constituted by `r nrow(year_county_panel)` county-year observations (i.e., `r nrow(appalachian_counties)` counties across nine years). For analysis, however, we restrict the panel to the three years prior to Medicaid expansion and the five years after, resulting in a final dataset of `r nrow(YC_panel)` observations. The discrepancy between these two datasets is due to Pennsylvania's delayed adoption of Medicaid.

The subset of US counties defined as "Appalachian" is based on the jurisdiction of the Appalachian Regional Council ([ARC, 2021](https://www.arc.gov/appalachian-counties-served-by-arc/)). Accordingly, our units of observation for this study are counties, with the representative population being people living in the Appalachian region. We focus on counties as units of observation because the Appalachian region is defined at the county-level and to avoid potential selection bias and small sample size issues that would confound state-level analysis. Furthermore, we assume that Appalachian counties are largely similar in terms on non-measurable, unobserved characteristics across state lines, meaning that they can be fairly reliably construed as pseudo “control” and “treatment” groups. That is to say, any given Appalachian county should not be significantly more likely to have benefited from state-level adoption of Medicaid expansion than any other, based on its inate characteristics.

Identification of state-level Medicaid expansion is based on tracking done by the Kaiser Family Foundation ([KFF, 2022](https://www.kff.org/medicaid/issue-brief/status-of-state-medicaid-expansion-decisions-interactive-map/)). Note that, due to the fact that Pennsylvania implemented Medicaid expansion a year after other expansion states, the timing of "treatment" for Appalachian counties in Pennsylvania is delayed by one year relative to other counties in expansion states. Additionally, we consider Virginia to be a non-expansion state for the purposes of this study, because it only enacted Medicaid expansion in 2019, well after the end of our study period.

Data on drug overdose death rates (i.e., deaths per 100,000 residents) comes from estimates modeled by the National Center for Health Statistics (NCHS), which are available at the county-level for the period 2003-2020. Unfortunately, county-level statistics on overdose deaths based on final counts of cause of death reporting only became available starting in 2020, outside of the time frame of this study.

County-level demographic covariates are taken from the US Census Bureau American Community Survey (ACS). Using these covariates, we hope to control for omitted variable bias stemming from county-level factors such as poverty rates, median age, and sex and race compositions. In particular, we expect that poverty rates would relate positively to overdose deaths, as poverty levels and overdose deaths have been previously linked ([Pear et al, 2019](https://pubmed.ncbi.nlm.nih.gov/30592998/)). We include controls for median age as drug overdose death incidence tends to vary by age group ([KFF, 2022](https://www.kff.org/other/state-indicator/opioid-overdose-deaths-by-age-group/?dataView=1&currentTimeframe=6&selectedDistributions=0-24--25-34--35-44--45-54&sortModel=%7B%22colId%22:%22Location%22,%22sort%22:%22asc%22%7D)). Drug overdose deaths are also more common among individuals identified as male than female ([CDC, 2022](https://www.cdc.gov/nchs/hus/topics/drug-overdose-deaths.htm)). Furthermore, access to drug treatment has been shown to differ according to race ([NIDA, 2019](https://nida.nih.gov/about-nida/noras-blog/2019/07/access-to-addiction-services-differs-by-race-gender)), potentially leading to differentials in drug overdose deaths depending on racial composition of counties.

Given that both the NCHS data on overdose death rates and ACS control variables are estimated at the county-level, we expand our study period to the three years prior to Medicaid expansion and the five years after (i.e., 2011-2019), in order to smooth over any potential estimation errors. We also hope that this larger time frame will capture any lags in treatment effects, given that reductions in drug overdose deaths due to expanded access to health care may not be reflected in the data until more than a year after Medicaid expansion.

From the sources, data is largely already available at the county-level, thus we are not required to perform any aggregation or dis-aggregation steps to make the data suitable for use. Furthermore, variables of interest are entirely quantitative, thus cleaning needs are minimal. All source data include county-specific FIPS codes as merging indices. The only intermediate data transformation we perform is the calculation of county-level racial composition shares and poverty rates, based on Census Bureau population data.

\medspace

# Descriptive Statistics

## Variation in Policy "Treatment"

In total, `r expansion_count[2]` Appalachian counties are located in expansion states and `r expansion_count[1]` Appalachian counties are located in non-expansion states.

We map Appalachian counties by Medicaid expansion status below:

```{r create map, include = FALSE}

county_shapes <- read_sf(dsn = 'data/cb_2021_us_county_5m/cb_2021_us_county_5m.shp')

county_shapes <- county_shapes %>% 
  mutate(FIPS = GEOID)

appalachian_counties_map <- appalachian_counties %>% 
  left_join(county_shapes, by = 'FIPS') %>% 
  select(FIPS, geometry, medicaid_expansion)

appalachian_counties_map$medicaid_expansion <- factor(appalachian_counties_map$medicaid_expansion,
                                    levels = c(0,1),
                                    labels = c("Non-Expansion", "Expansion"))

appalachian_counties_map <- st_as_sf(appalachian_counties_map)

expansion_map <- tm_shape(appalachian_counties_map) + 
  tm_polygons("medicaid_expansion",
              title = "Medicaid Expansion Status",
              palette = 'Pastel1') +
  tm_borders()
```

```{r fig1, fig.cap="Map of Medicaid Expansion Status Across Appalachian Counties"}
expansion_map
```

Note that Virginia did eventually enact Medicaid expansion in 2019, but these observations are not included in our analytical sample (2019 observations are only analyzed for Pennsylvania), and thus Appalachian counties in Virginia are considered to be "non-expansion" in our analysis. Clearly, at the state level there is a degree of "North-South" bias in terms of which states elected to expand Medicaid. However, our empirical strategy (as disucssed in the next section) aims to minimize any associated omitted variable bias with county-level fixed effects.

## Variation in Drug Overdose Death Rate

In the figure below, we plot the weighted-average of county-level drug overdose death rate over time (i.e., "Years since Medicaid Expansion"), separating counties in expansion states from counties in non-expansion states. 

```{r create line plot, include = FALSE}
line_plot_panel <- year_county_panel %>% 
    group_by(t_expansion, medicaid_expansion) %>% 
    summarize(estimated_overdose_death_rate = weighted.mean(
    estimated_overdose_death_rate, w = population, na.rm = T), .groups = 'drop') %>% 
    filter(between(t_expansion, -3, 4))

overdose_line_plot <- line_plot_panel %>% 
    ggplot(aes(x = t_expansion,
               y = estimated_overdose_death_rate,
               color = medicaid_expansion)) +
    geom_line() +
    geom_point() +
    geom_vline(aes(xintercept = -1)) +
    scale_color_brewer(palette = "Pastel1", name = "Medicaid Expansion Status") +
    labs(x = "Years since Medicaid Expansion",
         y = "Drug Overdose Deaths per 100,000")
```

\FloatBarrier

```{r fig2, fig.cap = "Yearly County-Level Drug Overdose Death Rates by Medicaid Expansion Status"}
overdose_line_plot
```

\FloatBarrier

While drug overdose death rates are persistently higher in expansion counties than in non-expansion counties, it appears that expansion counties and non-expansion counties experience near-parallel trends prior to Medicaid expansion. In the first few years following expansion, however, we observe an *steepening trend* of overdose death rates in *expansion counties* relative to *non-expansion counties*, indicating that Medicaid expansion had a *positive* effect on overdose death rates, contradicting the direction of our hypothesized causal effect.

Yet, we also observe that this steepening trend of overdose death rates in expansion counties *declines* following the first two years after Medicaid expansion. Between years three and four after Medicaid expansion, it even appears that parallel trends in overdose deaths have resumed. This suggests that, to the extent Medicaid expansion has increased overdose death rates in expansion counties, this effect was short-lived. 

## Variation in Key Continuous Variables

We also explore the balance across key continuous variables between counties in expansion states and counties in non-expansion states, at the time when Medicaid expansion occurs (i.e., Jan. 1st, 2014 for all states expect PA, Jan 1st, 2015 for PA).

```{r create diif in means, include = FALSE}
t_expansion_county_panel <- year_county_panel %>% 
  filter(t_expansion == 0) %>% 
  rename(weights = population,
         `Poverty Rate` = poverty_rate,
         `Median Age` = med_age,
         `Male Share` = male_share,
         `Black Share` = black_share,
         `Hispanic Share` = hisp_share,
         `White Share` = white_share,
         `Asian Share` = asian_share) %>%
  select('medicaid_expansion', 'Poverty Rate', 'Median Age', 'Male Share', 'Black Share', 'Hispanic Share', 'White Share', 'Asian Share')

#show diff between treatment and control groups 
diff_in_means_table <- datasummary_balance(~medicaid_expansion,
                    data = t_expansion_county_panel,
                    fmt = 2,
                    dinm_statistic = "p.value",
                    title = "Difference-in-means between Expansion and Non-Expansion Counties, in the Year of Medicaid Expansion",
                    notes = "Note: Observations are weighted by the population in each county.",
                    ) %>% 
  kable_styling(latex_options = "HOLD_position")
```

```{r display diff in means, echo = FALSE}
diff_in_means_table
```

Table 1 above shows difference-in-means between "treatment" (i.e., Medicaid expansion) counties and "control" counties in the year of Medicaid expansion. We observe statistically significant differences between "treatment" and "control" groups for male share of population and racial composition (i.e., Black, White, and Hispanic share of population). This suggests that these factors are unbalanced between the two groups of Appalachian counties, which would lead to omitted variable bias if they are not controlled for in our estimation specification.


\medspace

# Empirical Strategy

## Difference-in-Differences

The primary variation that we seek to exploit through our analysis is the differential in state-level adoption of Medicaid expansion across the Appalachian region, with policy variation at the state-level thus filtering down to the county-level. To evaluate the effect of Medicaid expansion on drug overdose deaths in Appalachian counties, we estimate the following "differences-in-differences" specification:

$$Overdose~Death~Rate_{it} = \beta Medicaid~Expansion_{it} + \textbf{X}_{it} \gamma + \nu_{i} + \tau_{t} + \varepsilon_{it}$$

where $Overdose~Death~Rate_{it}$ is deaths attributed to drug overdose per 100,000 county residents for county $i$ at time $t$, $Medicaid~Expansion_{it}$ is a binary variable that indicates "treatment" status (i.e., enactment of Medicaid expansion) for a county-year, $\textbf{X}_{it}$ is a vector of time varying controls (e.g., poverty rates, median age, male population share, racial composition) for potential county-level determinants of overdose death rates outside of our policy variation of interest.

Additionally, we include an array of county fixed effects, $\nu_{i}$, that control for unobserved time-invariant factors that are specific to individual counties. An example of one such factor would be if, throughout the entire 2011-2019 period, a specific county had its own drug treatment program that reduced drug overdose deaths compared to other counties, all else equal. We further include $\tau_{t}$, year fixed effects, to control for unobserved county-invariant factors that might have changed between each year included in our panel. Such factors would include events such as periodic economic shocks that affect the entire Appalachian region in certain years, which potentially could be deterministic of the rate of overdose deaths. Finally, $\varepsilon_{it}$ is the idiosyncratic error term.

## Event Study

\medspace

# Findings

## Difference-in-Difference Results

We test two model specifications to estimate difference-in-difference effects. The first considers effects up to two years following Medicaid expansion, while the second considers effects up to five years following Medicaid expansion. We evaluate both of these specifications to determine if the effect of Medicaid expansion on drug overdose death rates was short-lived (i.e., only significant in the period two years after expansion), or if the effect persisted for a longer period.

```{r estimate models, include = FALSE}
# Estimate two models, one for the period up until two years after expansion, another for the period up to four years after expansion

panel_t_2 <- YC_panel %>%
  filter(t_expansion < 2)

did_models <- list(
  
  "Two Years Post-Expansion" <- feols(estimated_overdose_death_rate ~ 
                                         treat + poverty_rate + med_age + male_pop + black_pop + hisp_pop + asian_pop | COUNTY + Year, 
                data = panel_t_2,
                weights = panel_t_2$population,
                cluster = panel_t_2$COUNTY),
  
  "Five Years Post-Expansion" <- feols(estimated_overdose_death_rate ~ 
                                         treat + poverty_rate + med_age + male_pop + black_pop + hisp_pop + asian_pop | COUNTY + Year, 
                data = YC_panel,
                weights = YC_panel$population,
                cluster = YC_panel$COUNTY)
)

names(did_models) <- c("Two Years Post-Expansion", "Five Years Post-Expansion")

#set up an object to customize your regression table goodness-of-fit statistics
gm <- tibble::tribble(
    ~raw,        ~clean,          ~fmt,
    "nobs",               "N",                  0,
    "r.squared",          "R-squared",      3,
    "adj.r.squared",      "Adj. R-squared", 3,
    "FE: COUNTY",         "County FEs",          0,
    "FE: Year",    "Year FEs",    0
    )

#display results with added formatting options    
did_estimation_results <- modelsummary(did_models,
             fmt = "%.4f",
             coef_omit = 'Intercept',
             coef_rename = c("treat" = "Medicaid Expansion", 
                             "poverty_rate" = "Poverty Rate (0-100)",
                             "med_age" = "Median Age",
                             "male_pop" = "Male Population Share (0-100)",
                             "black_pop" = "Black Population Share",
                             "hisp_pop" = "Hispanic Population Share",
                             "asian_pop" = "Asian Population Share"),
             gof_map = gm,
             title = 'Effect of Medicaid Expansion on Drug Overdose Death Rates',
             stars = c('*' = .1, '**' = .05, '***' = .01),
             notes = 'Robust standard errors clustered by county are shown in parentheses.
                      Observations are weighted by the population in each county.') %>% 
  kable_styling(latex_options = c("hold_position", "scale_down"))

```

```{r display estimates, echo = FALSE}
did_estimation_results
```

Table 2 displays difference-in-difference estimation results for "treatment" effects two- and four-years following Medicaid expansion. In both cases, we find evidence that Medicaid Expansion had a positive and statistically significant (p < 0.01) effect on drug overdose deaths, holding constant an array of time- and county-variant factors (e.g., poverty rates, age, male population share, and racial composition), and controlling for county and year fixed effects.

In particular, our estimates suggest that we can causally attribute Medicaid expansion in Appalachian counties to an *increase* in drug overdose death rates of *roughly 4 deaths per 100,000* in the two years following expansion. When expanding the time frame used to estimate the effect of Medicaid expansion to the four years following expansion, we find an *even greater* attributable increase in overdose death rates due to Medicaid expansion of *nearly 8 deaths per 100,000*. As such, we find that the effect of Medicaid expansion on overdose death rates in Appalachian counties not only persisted over time, but actually grew larger.

Among control variables, we note some statistically significant associations that link county-level overdose death rates with poverty rates, male population share, Black population share, and Asian population share. Outside of poverty rates, however, where statistically significant, the size of these estimates are too small to provide much inferential value (e.g., a 100 percentage-point increase in Black population share decreases the overdose death rate by less than 1 death per 100,000, all else held constant).

## Event Study

```{r}
ES_mod <- feols(
  estimated_overdose_death_rate ~ i(factor(t_expansion), as.numeric(medicaid_expansion), ref = -1) 
  + poverty_rate + med_age + male_pop + black_pop + hisp_pop + asian_pop
  | COUNTY + Year,
  data = YC_panel, 
  weight = YC_panel$population,
  cluster = YC_panel$COUNTY)

```

```{r}
# Plot event study
iplot(
  ES_mod,
  pt.join = TRUE,
  ci.join = TRUE,
  ci.lwd = 0,
  grid.par = list(vert = FALSE),
  main = "Medicaid Expansion and Drug Overdose Death Rates",
  ylab = "Overdose Death Rates",
  xlab = "Years since Medicaid Expansion")
```

\medspace

# Conclusion

TL;DR Medicaid expansion had some pretty awful unintended consequences. Most likely explanation: Medicaid expansion increased access to prescription opioids, resulting in higher rates of drug overdose deaths.

OVB is fairly likely, but the direction of bias is not clear. Tried to control for SUDs treatment centers but could not.

\medspace

# Appendices

## Appendix I: Data Sources

We compile publicly-available data from the Appalachian Regional Council (ARC), Kaiser Family Foundation (KFF), National Center for Health Statistics (NCHS), and the US Census Bureau into a single county-year panel data set.

### Appalachian Counties Data

The Appalachian Regional Commission defines 423 counties in 13 states (West Virginia, Alabama, Georgia, Kentucky, Maryland, Mississippi, New York, North Carolina, Ohio, Pennsylvania, South Carolina, Tennessee, and Virginia) as demarcating the Appalachian region. We adopt this geographical definition in our research approach.

More information available at: https://www.arc.gov/appalachian-counties-served-by-arc/.

```{r load county data}
appalachian_counties <- read_excel('data/appalachian_counties_ARC_2021.xlsx')
```

### Medicaid Expansion

Of the 13 states, five states (Kentucky, Maryland, New York, Ohio, and West Virginia) passed legislation mandating the expansion of Medicaid as of January 1st, 2014. Two additional states, Pennsylvania and Virginia, would later expand Medicaid, with the former in 2015 and the latter in 2019. Six states (Alabama, Georgia, Mississippi, North Carolina, South Carolina, and Tennessee) have not expanded Medicaid to-date.

We add a dummy variable into our data to reflect this policy difference. Information on state-level Medicaid expansion available at: https://www.kff.org/medicaid/issue-brief/status-of-state-medicaid-expansion-decisions-interactive-map/.

```{r code policy variables}
# Create dummy variable for medicaid expansion and a variable for date of expansion

expansion <- c("Kentucky", "Maryland", "New York", "Ohio", "West Virginia",
                     "Pennsylvania")
no_expansion <- c("Alabama", "Georgia", "Mississippi", "North Carolina", 
                  "South Carolina", "Tennessee", "Virginia")

appalachian_counties <- appalachian_counties %>% 
  mutate(medicaid_expansion = as.numeric(STATE %in% expansion),
         expansion_date = make_date(2014, 1, 1))

# Re-code dates for Pennsylvania (late expansion)

appalachian_counties$expansion_date[appalachian_counties$STATE == "Pennsylvania"] <-
  make_date(2015,1,1)

```

### Overdose Deaths

Our data on drug overdose deaths comes from estimates modeled by the National Center for Health Statistics (NCHS), which are available at the county-level for the period 2003-2020. Source link: https://www.cdc.gov/nchs/data-visualization/drug-poisoning-mortality/.

```{r load overdose data}
overdose_data <- read_csv("data/NCHS_-_Drug_Poisoning_Mortality_by_County__United_States.csv")

# Keep columns for FIPS codes, year, and modeled overdose deaths

overdose_data <- overdose_data %>% 
  select(FIPS, Year, `Model-based Death Rate`) %>%
  rename(estimated_overdose_death_rate = `Model-based Death Rate`)
```

### County-Level Demographics

To control for time-variant, county-variant factors, we pull demographic data from the US Census Bureau's American Community Survey (ACS), for years 2011-2019. Data is downloaded from the US Census Bureau API using the R package tidycensus.

```{r load ACS data}
census_api_key("b79b301dc87bb0fd551147883a8141dca4e2823e")

# Pull 2011 ACS county-level data 

acs_2011 <- get_acs(geography = "county",
                   variables = c(population = "B01001_001",
                                 white_pop = "B01001H_001",
                                 hisp_pop = "B01001I_001",
                                 asian_pop = "B02001_005",
                                 black_pop = "B02001_003",
                                 male_pop = "B01001_002",
                                 med_income = "B19013_001",
                                 med_age = "B01002_001",
                                 pov = "B17025_002"),
                   year = 2011)

acs_2011 <- acs_2011 %>% 
  select(-moe, -NAME) %>% 
  spread(key = variable, value = estimate) %>% 
  mutate(Year = 2011,
         white_share = 100 * (white_pop/population),
         hisp_share = 100 * (hisp_pop/population),
         asian_share = 100 * (asian_pop/population),
         black_share = 100 * (black_pop/population),
         male_share = 100 * (male_pop/population),
         poverty_rate = 100 * (pov/population))


# Pull 2012 ACS county-level data 

acs_2012 <- get_acs(geography = "county",
                   variables = c(population = "B01001_001",
                                 white_pop = "B01001H_001",
                                 hisp_pop = "B01001I_001",
                                 asian_pop = "B02001_005",
                                 black_pop = "B02001_003",
                                 male_pop = "B01001_002",
                                 med_income = "B19013_001",
                                 med_age = "B01002_001",
                                 pov = "B17025_002"),
                   year = 2012)

acs_2012 <- acs_2012 %>% 
  select(-moe, -NAME) %>% 
  spread(key = variable, value = estimate) %>% 
  mutate(Year = 2012,
         white_share = 100 * (white_pop/population),
         hisp_share = 100 * (hisp_pop/population),
         asian_share = 100 * (asian_pop/population),
         black_share = 100 * (black_pop/population),
         male_share = 100 * (male_pop/population),
         poverty_rate = 100 * (pov/population))

# Pull 2013 ACS county-level data 

acs_2013 <- get_acs(geography = "county",
                   variables = c(population = "B01001_001",
                                 white_pop = "B01001H_001",
                                 hisp_pop = "B01001I_001",
                                 asian_pop = "B02001_005",
                                 black_pop = "B02001_003",
                                 male_pop = "B01001_002",
                                 med_income = "B19013_001",
                                 med_age = "B01002_001",
                                 pov = "B17025_002"),
                   year = 2013)

acs_2013 <- acs_2013 %>% 
  select(-moe, -NAME) %>% 
  spread(key = variable, value = estimate) %>% 
  mutate(Year = 2013,
         white_share = 100 * (white_pop/population),
         hisp_share = 100 * (hisp_pop/population),
         asian_share = 100 * (asian_pop/population),
         black_share = 100 * (black_pop/population),
         male_share = 100 * (male_pop/population),
         poverty_rate = 100 * (pov/population))

# Pull 2014 ACS county-level data 

acs_2014 <- get_acs(geography = "county",
                   variables = c(population = "B01001_001",
                                 white_pop = "B01001H_001",
                                 hisp_pop = "B01001I_001",
                                 asian_pop = "B02001_005",
                                 black_pop = "B02001_003",
                                 male_pop = "B01001_002",
                                 med_income = "B19013_001",
                                 med_age = "B01002_001",
                                 pov = "B17025_002"),
                   year = 2014)

acs_2014 <- acs_2014 %>% 
  select(-moe, -NAME) %>% 
  spread(key = variable, value = estimate) %>% 
  mutate(Year = 2014,
         white_share = 100 * (white_pop/population),
         hisp_share = 100 * (hisp_pop/population),
         asian_share = 100 * (asian_pop/population),
         black_share = 100 * (black_pop/population),
         male_share = 100 * (male_pop/population),
         poverty_rate = 100 * (pov/population))

# Pull 2015 ACS county-level data 

acs_2015 <- get_acs(geography = "county",
                   variables = c(population = "B01001_001",
                                 white_pop = "B01001H_001",
                                 hisp_pop = "B01001I_001",
                                 asian_pop = "B02001_005",
                                 black_pop = "B02001_003",
                                 male_pop = "B01001_002",
                                 med_income = "B19013_001",
                                 med_age = "B01002_001",
                                 pov = "B17025_002"),
                   year = 2015)

acs_2015 <- acs_2015 %>% 
  select(-moe, -NAME) %>% 
  spread(key = variable, value = estimate) %>% 
  mutate(Year = 2015,
         white_share = 100 * (white_pop/population),
         hisp_share = 100 * (hisp_pop/population),
         asian_share = 100 * (asian_pop/population),
         black_share = 100 * (black_pop/population),
         male_share = 100 * (male_pop/population),
         poverty_rate = 100 * (pov/population))

# Pull 2016 ACS county-level data 

acs_2016 <- get_acs(geography = "county",
                   variables = c(population = "B01001_001",
                                 white_pop = "B01001H_001",
                                 hisp_pop = "B01001I_001",
                                 asian_pop = "B02001_005",
                                 black_pop = "B02001_003",
                                 male_pop = "B01001_002",
                                 med_income = "B19013_001",
                                 med_age = "B01002_001",
                                 pov = "B17025_002"),
                   year = 2016)

acs_2016 <- acs_2016 %>% 
  select(-moe, -NAME) %>% 
  spread(key = variable, value = estimate) %>% 
  mutate(Year = 2016,
         white_share = 100 * (white_pop/population),
         hisp_share = 100 * (hisp_pop/population),
         asian_share = 100 * (asian_pop/population),
         black_share = 100 * (black_pop/population),
         male_share = 100 * (male_pop/population),
         poverty_rate = 100 * (pov/population))

# Pull 2017 ACS county-level data 

acs_2017 <- get_acs(geography = "county",
                   variables = c(population = "B01001_001",
                                 white_pop = "B01001H_001",
                                 hisp_pop = "B01001I_001",
                                 asian_pop = "B02001_005",
                                 black_pop = "B02001_003",
                                 male_pop = "B01001_002",
                                 med_income = "B19013_001",
                                 med_age = "B01002_001",
                                 pov = "B17025_002"),
                   year = 2017)

acs_2017 <- acs_2017 %>% 
  select(-moe, -NAME) %>% 
  spread(key = variable, value = estimate) %>% 
  mutate(Year = 2017,
         white_share = 100 * (white_pop/population),
         hisp_share = 100 * (hisp_pop/population),
         asian_share = 100 * (asian_pop/population),
         black_share = 100 * (black_pop/population),
         male_share = 100 * (male_pop/population),
         poverty_rate = 100 * (pov/population))

# Pull 2018 ACS county-level data 

acs_2018 <- get_acs(geography = "county",
                   variables = c(population = "B01001_001",
                                 white_pop = "B01001H_001",
                                 hisp_pop = "B01001I_001",
                                 asian_pop = "B02001_005",
                                 black_pop = "B02001_003",
                                 male_pop = "B01001_002",
                                 med_income = "B19013_001",
                                 med_age = "B01002_001",
                                 pov = "B17025_002"),
                   year = 2018)

acs_2018 <- acs_2018 %>% 
  select(-moe, -NAME) %>% 
  spread(key = variable, value = estimate) %>% 
  mutate(Year = 2018,
         white_share = 100 * (white_pop/population),
         hisp_share = 100 * (hisp_pop/population),
         asian_share = 100 * (asian_pop/population),
         black_share = 100 * (black_pop/population),
         male_share = 100 * (male_pop/population),
         poverty_rate = 100 * (pov/population))

# Pull 2019 ACS county-level data 

acs_2019 <- get_acs(geography = "county",
                   variables = c(population = "B01001_001",
                                 white_pop = "B01001H_001",
                                 hisp_pop = "B01001I_001",
                                 asian_pop = "B02001_005",
                                 black_pop = "B02001_003",
                                 male_pop = "B01001_002",
                                 med_income = "B19013_001",
                                 med_age = "B01002_001",
                                 pov = "B17025_002"),
                   year = 2019)

acs_2019 <- acs_2019 %>% 
  select(-moe, -NAME) %>% 
  spread(key = variable, value = estimate) %>% 
  mutate(Year = 2019,
         white_share = 100 * (white_pop/population),
         hisp_share = 100 * (hisp_pop/population),
         asian_share = 100 * (asian_pop/population),
         black_share = 100 * (black_pop/population),
         male_share = 100 * (male_pop/population),
         poverty_rate = 100 * (pov/population))

# Append into single ACS data frame, rename GEOID as FIPS

acs_11_to_19 <- rbind(acs_2011, acs_2012, acs_2013, acs_2014, acs_2015, acs_2016, acs_2017, acs_2018, acs_2019)
acs_11_to_19 <- acs_11_to_19 %>% 
  mutate(GEOID = as.numeric(GEOID)) %>% 
  rename(FIPS = GEOID)
```

### Geographic Boundaries

In addition to county-level demographics, we pull county shapefiles from the Census Bureau for mapping visuals: https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html

## Merge Data into Consolidated Data Set

We merge the Appalachian counties data, overdose data, and ACS data into a single data set. We save the resulting panel dataframe and county-level dataframe as .rds files, so that they can be loaded at the beginning of this file and elsewhere.

```{r merge data}

# Create four versions of the Appalachian counties data, one for each year in our study, 
# merge with other data, then append into a panel

appalachian_counties_11 <- appalachian_counties %>% 
  mutate(Year = 2011)
appalachian_counties_12 <- appalachian_counties %>% 
  mutate(Year = 2012)
appalachian_counties_13 <- appalachian_counties %>% 
  mutate(Year = 2013)
appalachian_counties_14 <- appalachian_counties %>% 
  mutate(Year = 2014)
appalachian_counties_15 <- appalachian_counties %>% 
  mutate(Year = 2015)
appalachian_counties_16 <- appalachian_counties %>% 
  mutate(Year = 2016)
appalachian_counties_17 <- appalachian_counties %>% 
  mutate(Year = 2017)
appalachian_counties_18 <- appalachian_counties %>% 
  mutate(Year = 2018)
appalachian_counties_19 <- appalachian_counties %>% 
  mutate(Year = 2019)

appalachian_counties_panel <- rbind(appalachian_counties_11,
                                    appalachian_counties_12,
                                    appalachian_counties_13,
                                    appalachian_counties_14,
                                    appalachian_counties_15,
                                    appalachian_counties_16,
                                    appalachian_counties_17,
                                    appalachian_counties_18,
                                    appalachian_counties_19)

# Create variable for time since expansion and treatment variable

appalachian_counties_panel <- appalachian_counties_panel %>% 
  mutate(t_expansion = Year - year(expansion_date),
        treat = ifelse(t_expansion >= 0, medicaid_expansion, 0))

# Merge panel with overdose data

appalachian_counties_overdose_panel <- appalachian_counties_panel %>% 
  mutate(FIPS = as.numeric(FIPS)) %>% 
  left_join(overdose_data, by = c("FIPS", "Year"))

# Merge panel with ACS data (save as an RDS file)

yearly_counties_panel_overdose_acs <- appalachian_counties_overdose_panel %>% 
  left_join(acs_11_to_19, by = c("FIPS", "Year"))

# Turn expansion dummy variable into a factor

yearly_counties_panel_overdose_acs$medicaid_expansion <- 
  factor(yearly_counties_panel_overdose_acs$medicaid_expansion,
                                    levels = c(0,1),
                                    labels = c("Non-Expansion", "Expansion"))

# Save panel and county datasets as .rds files

saveRDS(yearly_counties_panel_overdose_acs, file = "yearly_panel.rds")
saveRDS(appalachian_counties, file = "appalachian_counties.rds")
```

## Appendix II: Defining "High" and "Low" Risk Counties







